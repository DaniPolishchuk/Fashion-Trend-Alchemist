apiVersion: apps/v1
kind: Deployment
metadata:
  name: fashion-alchemist-pod
  namespace: danispace
  labels:
    app: fashion-alchemist
    app.kubernetes.io/name: fashion-alchemist
    app.kubernetes.io/component: application
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fashion-alchemist
  template:
    metadata:
      labels:
        app: fashion-alchemist
    spec:
      containers:
        # Approuter container - handles authentication and routing
        - name: approuter
          image: danylopolishchuk884/fashion-alchemist-approuter:latest
          ports:
            - containerPort: 5000
              name: approuter
          env:
            - name: PORT
              value: '5000'
            - name: destinations
              valueFrom:
                configMapKeyRef:
                  name: approuter-destinations
                  key: destinations
            - name: TENANT_HOST_PATTERN
              value: '^(.*)fashion-alchemist.a549aaa.kyma.ondemand.com'
            - name: XS_APP_LOG_LEVEL
              value: 'info'
            - name: VCAP_SERVICES
              valueFrom:
                configMapKeyRef:
                  name: vcap-services
                  key: VCAP_SERVICES
          resources:
            requests:
              memory: '128Mi'
              cpu: '50m'
            limits:
              memory: '256Mi'
              cpu: '100m'
          livenessProbe:
            httpGet:
              path: /
              port: 5000
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: 5000
            initialDelaySeconds: 5
            periodSeconds: 10

        # Frontend container - nginx serving React app
        - name: frontend
          image: danylopolishchuk884/fashion-alchemist-web:latest
          ports:
            - containerPort: 80
              name: http
          resources:
            requests:
              memory: '128Mi'
              cpu: '50m'
            limits:
              memory: '256Mi'
              cpu: '100m'
          livenessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 80
            initialDelaySeconds: 3
            periodSeconds: 10

        # Backend container - Fastify API
        - name: backend
          image: danylopolishchuk884/fashion-alchemist-api:latest
          ports:
            - containerPort: 3001
              name: api
          envFrom:
            - configMapRef:
                name: fashion-alchemist-app-config
            - secretRef:
                name: fashion-alchemist-secrets
          env:
            # XSUAA credentials for JWT validation
            - name: XSUAA_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: fashion-alchemist-xsuaa-credentials
                  key: clientid
            - name: XSUAA_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: fashion-alchemist-xsuaa-credentials
                  key: clientsecret
            - name: XSUAA_URL
              valueFrom:
                secretKeyRef:
                  name: fashion-alchemist-xsuaa-credentials
                  key: url
            - name: XSUAA_UAA_DOMAIN
              valueFrom:
                secretKeyRef:
                  name: fashion-alchemist-xsuaa-credentials
                  key: uaadomain
            - name: XSUAA_VERIFICATION_KEY
              valueFrom:
                secretKeyRef:
                  name: fashion-alchemist-xsuaa-credentials
                  key: verificationkey
            - name: XSUAA_XSAPPNAME
              valueFrom:
                secretKeyRef:
                  name: fashion-alchemist-xsuaa-credentials
                  key: xsappname
          resources:
            requests:
              memory: '512Mi'
              cpu: '250m'
            limits:
              memory: '1Gi'
              cpu: '500m'
          livenessProbe:
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 5
            periodSeconds: 10
